"use strict";!function(){angular.module("sistemiumAngularAuth.models",["sistemiumAngularAuth.services"])}(),function(){angular.module("sistemiumAngularAuth.services",["sistemium.schema"])}(),function(){angular.module("sistemiumAngularAuth",["sistemium","sistemium.schema","sistemium.util","ui.router","LocalStorageModule","sistemiumAngularAuth.services","sistemiumAngularAuth.models"]).config(function(t){t.interceptors.push("saAuthInterceptor")})}(),function(){function t(t,n,e,r){return{request:function(t){var n=e.get();return t.headers=t.headers||{},n&&(t.headers.authorization=n),t},responseError:function(u){if(401===u.status||403===u.status){if(!r.loginState)throw new Error("saaAppConfig.loginState not defined...");n.get("$state").go(r.loginState),e.destroy()}return t.reject(u)}}}angular.module("sistemiumAngularAuth").factory("saAuthInterceptor",t)}(),function(){angular.module("sistemiumAngularAuth.models").run(function(t,n){t.register({name:"saAccount",endpoint:"/account",basePath:n.authApiUrl,relations:{hasMany:{providerAccount:{localField:"providers",foreignKey:"accountId"}}}})})}(),function(){angular.module("sistemiumAngularAuth.models").run(function(t,n){t.register({name:"saProviderAccount",basePath:n.apiUrl})})}(),function(){function t(t,n){var e="access-token",r=t.get(e);return n.$on("logged-off",function(){r=void 0}),{get:function(){return r},save:function(n){r=n,t.set(e,n)},destroy:function(){t.remove(e)}}}angular.module("sistemiumAngularAuth.models").service("saToken",t)}(),angular.module("sistemiumAngularAuth.services").service("AuthSchema",function(t,n){return t({getCount:function(t){var e=this,r=e.getAdapter("http").defaults.basePath;return n.get(r+"/"+e.endpoint,{params:angular.extend({"agg:":"count"},t||{})}).then(function(t){return parseInt(t.headers("x-aggregate-count"))||t.data&&t.data.count})},getList:function(t){return this.findAll(t,{bypassCache:!0})}})}),function(){function t(t,n,e,r,u,o,a){var i,s=u.safeCb,c={},l="roles",g="logged-off",f="logged-in",h=o.model("saAccount");r.get()&&"/logout"!==t.path()&&(c=h.find("me"),c.then(function(t){h.loadRelations(t,["saProviderAccount"]).then(function(){c=t}),console.log("logged-in",t),a.$broadcast(f)}));var m={loginWithMobileNumber:function(t){return n.get(m.config.phaUrl+t)},authWithSmsCode:function(t,e){return n.get(m.config.authUrl+"/auth/pha/"+t+"/"+e).then(function(t){var n=t.headers("x-access-token");return{token:n,user:t.data}})},login:function(t,u){return n.get(m.config.authUrl+"/api/token/"+t,{headers:{authorization:t}}).then(function(){r.save(t),h.find("me").then(function(t){return c=t,s(u)(null,c),a.$broadcast("logged-in"),c}).catch(function(t){console.log(t)})}).catch(function(t){return m.logout(),s(u)(t.data),e.reject(t.data)})},logout:function(){r.destroy(),c={},a.$broadcast(g)},createUser:function(t,n){return h.create(t).then(function(e){return r.save(e.token),c=h.find("me"),s(n)(null,t)},function(t){return m.logout(),s(n)(t)})},getCurrentUser:function(t){if(0===arguments.length)return c;var n=c.hasOwnProperty("$$state")?c:c;return e.when(n).then(function(n){return s(t)(n),n},function(){return s(t)({}),{}})},isLoggedIn:function(t){return 0===arguments.length?c.hasOwnProperty(l):m.getCurrentUser(null).then(function(n){var e=n.hasOwnProperty(l);return s(t)(e),e})},hasRole:function(t,n){var e=function(t,n){return i=m.config.userRoles||[],i.indexOf(t)>=i.indexOf(n)};return arguments.length<2?e(c.role,t):m.getCurrentUser(null).then(function(r){var u=r.hasOwnProperty(l)?e(r.roles,t):!1;return s(n)(u),u})},isAdmin:function(){return m.hasRole.apply(m,[].concat.apply(["admin"],arguments))},getToken:function(){return r.get()}};return function(t){return m.config=t,m}}angular.module("sistemiumAngularAuth.services").factory("saAuth",t)}();