"use strict";!function(){angular.module("sistemiumAngularAuth.models",["sistemiumAngularAuth.services"])}(),function(){angular.module("sistemiumAngularAuth.services",["sistemium.schema"])}(),function(){angular.module("sistemiumAngularAuth",["sistemium","sistemium.schema","sistemium.util","ui.router","LocalStorageModule","sistemiumAngularAuth.services","sistemiumAngularAuth.models"]).config(function(t){t.interceptors.push("saAuthInterceptor")})}(),function(){function t(t,n,e,r){return{request:function(t){var n=e.get();return t.headers=t.headers||{},n&&(t.headers.authorization=n),t},responseError:function(u){if(401===u.status){if(!r.loginState)throw new Error("saaAppConfig.loginState not defined...");n.get("$state").go(r.loginState),e.destroy()}return t.reject(u)}}}angular.module("sistemiumAngularAuth").factory("saAuthInterceptor",t)}(),function(){angular.module("sistemiumAngularAuth.models").run(function(t,n){t.register({name:"saAccount",endpoint:"/account",basePath:n.authApiUrl,relations:{hasMany:{providerAccount:{localField:"providers",foreignKey:"accountId"}}}})})}(),function(){angular.module("sistemiumAngularAuth.models").run(function(t,n){t.register({name:"saProviderAccount",basePath:n.apiUrl})})}(),function(){function t(t,n){var e="access-token",r=t.get(e);return n.$on("logged-off",function(){r=void 0}),{get:function(){return r},save:function(n){r=n,t.set(e,n)},destroy:function(){t.remove(e)}}}angular.module("sistemiumAngularAuth.models").service("saToken",t)}(),angular.module("sistemiumAngularAuth.services").service("AuthSchema",function(t,n){return t({getCount:function(t){var e=this,r=e.getAdapter("http").defaults.basePath;return n.get(r+"/"+e.endpoint,{params:angular.extend({"agg:":"count"},t||{})}).then(function(t){return parseInt(t.headers("x-aggregate-count"))||t.data&&t.data.count})},getList:function(t){return this.findAll(t,{bypassCache:!0})}})}),function(){function t(t,n,e,r,u,o,a){function i(n){return m.config=n,n.Account&&(d=n.Account),r.get()&&"/logout"!==t.path()&&(l=d.find("me"),l.then(function(t){d.loadRelations(t,["saProviderAccount"]).then(function(){l=t}),console.log("logged-in",t),a.$broadcast(h)})),m}var s,c=u.safeCb,l={},g="roles",f="logged-off",h="logged-in",m={},d=o.model("saAccount");return angular.extend(m,{loginWithMobileNumber:function(t){return n.get(m.config.phaUrl+t)},authWithSmsCode:function(t,e){return n.get(m.config.authUrl+"/auth/pha/"+t+"/"+e).then(function(t){var n=t.headers("x-access-token");return{token:n,user:t.data}})},login:function(t,u){return n.get(m.config.authUrl+"/api/token/"+t,{headers:{authorization:t}}).then(function(){r.save(t),d.find("me").then(function(t){return l=t,c(u)(null,l),a.$broadcast("logged-in"),l}).catch(function(t){console.log(t)})}).catch(function(t){return m.logout(),c(u)(t.data),e.reject(t.data)})},logout:function(){r.destroy(),l={},a.$broadcast(f)},createUser:function(t,n){return d.create(t).then(function(e){return r.save(e.token),l=d.find("me"),c(n)(null,t)},function(t){return m.logout(),c(n)(t)})},getCurrentUser:function(t){if(0===arguments.length)return l;var n=l.hasOwnProperty("$$state")?l:l;return e.when(n).then(function(n){return c(t)(n),n},function(){return c(t)({}),{}})},isLoggedIn:function(t){return 0===arguments.length?l.hasOwnProperty(g):m.getCurrentUser(null).then(function(n){var e=n.hasOwnProperty(g);return c(t)(e),e})},hasRole:function(t,n){var e=function(t,n){return s=m.config.userRoles||[],s.indexOf(t)>=s.indexOf(n)};return arguments.length<2?e(l.role,t):m.getCurrentUser(null).then(function(r){var u=r.hasOwnProperty(g)?e(r.roles,t):!1;return c(n)(u),u})},isAdmin:function(){return m.hasRole.apply(m,[].concat.apply(["admin"],arguments))},getToken:function(){return r.get()}}),i}angular.module("sistemiumAngularAuth.services").factory("saAuth",t)}();