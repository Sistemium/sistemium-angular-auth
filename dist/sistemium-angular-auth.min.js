"use strict";!function(){angular.module("sistemiumAngularAuth.models",["sistemiumAngularAuth.services"])}(),function(){angular.module("sistemiumAngularAuth.services",["sistemium.schema"])}(),function(){angular.module("sistemiumAngularAuth",["sistemium","sistemium.schema","sistemium.util","ui.router","LocalStorageModule","sistemiumAngularAuth.services","sistemiumAngularAuth.models"]).config(function(n){n.interceptors.push("saAuthInterceptor")})}(),function(){function n(n,t,e,u){return{request:function(n){var t=e.get();return n.headers=n.headers||{},t&&(n.headers.authorization=t),n},responseError:function(r){if(401===r.status){if(!u.loginState)throw new Error("saaAppConfig.loginState not defined...");t.get("$state").go(u.loginState),e.destroy()}return n.reject(r)}}}angular.module("sistemiumAngularAuth").factory("saAuthInterceptor",n)}(),function(){angular.module("sistemiumAngularAuth.models").run(function(n,t){n.register({name:"saAccount",endpoint:"/account",basePath:t.authApiUrl,relations:{hasMany:{providerAccount:{localField:"providers",foreignKey:"accountId"}}}})})}(),function(){angular.module("sistemiumAngularAuth.models").run(function(n,t){n.register({name:"saProviderAccount",basePath:t.apiUrl})})}(),function(){function n(n,t){var e="access-token",u=n.get(e);return t.$on("logged-off",function(){u=void 0}),{get:function(){return u},save:function(t){u=t,n.set(e,t)},destroy:function(){n.remove(e)}}}angular.module("sistemiumAngularAuth.models").service("saToken",n)}(),angular.module("sistemiumAngularAuth.services").service("AuthSchema",function(n,t){return n({getCount:function(n){var e=this,u=e.getAdapter("http").defaults.basePath;return t.get(u+"/"+e.endpoint,{params:angular.extend({"agg:":"count"},n||{})}).then(function(n){return parseInt(n.headers("x-aggregate-count"))||n.data&&n.data.count})},getList:function(n){return this.findAll(n,{bypassCache:!0})}})}),function(){function n(n,t,e,u,r,o,a){function i(t){return d.config=t,t.Account&&(h=t.Account),u.get()&&"/logout"!==n.path()&&(l=h.find("me"),l.then(function(n){h.loadRelations(n,["saProviderAccount"]).then(function(){l=n}),console.log("logged-in",n),a.$broadcast(m)})),d}var s,c=r.safeCb,l={},g="roles",f="logged-off",m="logged-in",d={},h=o.model("saAccount");return angular.extend(d,{login:function(n,r){return t.get(d.config.authUrl+"/api/token/"+n,{headers:{authorization:n}}).then(function(){u.save(n),h.find("me").then(function(n){return l=n,c(r)(null,l),a.$broadcast("logged-in"),l}).catch(function(n){console.log(n)})}).catch(function(n){return d.logout(),c(r)(n.data),e.reject(n.data)})},logout:function(){u.destroy(),l={},a.$broadcast(f)},createUser:function(n,t){return h.create(n).then(function(e){return u.save(e.token),l=h.find("me"),c(t)(null,n)},function(n){return d.logout(),c(t)(n)})},getCurrentUser:function(n){return 0===arguments.length?l:e.when(l).then(function(t){return c(n)(t),t},function(){return c(n)({}),{}})},isLoggedIn:function(n){return 0===arguments.length?l.hasOwnProperty(g):d.getCurrentUser(null).then(function(t){var e=t.hasOwnProperty(g);return c(n)(e),e})},hasRole:function(n,t){var e=function(n,t){return s=d.config.userRoles||[],s.indexOf(n)>=s.indexOf(t)};return arguments.length<2?e(l.role,n):d.getCurrentUser(null).then(function(u){var r=u.hasOwnProperty(g)?e(u.roles,n):!1;return c(t)(r),r})},isAdmin:function(){return d.hasRole.apply(d,[].concat.apply(["admin"],arguments))},getToken:function(){return u.get()}}),i}angular.module("sistemiumAngularAuth.services").factory("saAuth",n)}();